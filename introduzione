Introduzione alla mappa BDTRE-OSM del Piemonte
==============================================

1. Panoramica
-----------

La mappa BDTRE-OSM del Piemonte è una mappa sinottica che utilizza i dati del BDTRE
della Regione Piemonte e OSM.
È una mappa specialistica:
La base topografica, che è derivato dal BDTRE aggiornato al 2015.
Da una prima analisi dei dati, alcune caratteristiche sono mancanti e/o non pienamente utilizzabili ed allora si implementano
in parte i dati OSM, che sono recenti ma anche incompleti.
La sinossi di tempi mostra le stesse caratteristiche provenienti da entrambi i set di dati: una strada può apparire come una
fascia gialla (un poligono, preso dal BDTRE) con una strada simboleggiato su di esso (tratto da OSM).
Ciò può essere fonte di confusione, soprattutto se le caratteristiche non vanno a sovrapporsi correttamente.

Inoltre, il BDTRE contiene caratteristiche che sono scomparsi o non sono mai state verificate precisamente, i dati sono spesso ricavati da ortofoto di varia data ed altre interpretazioni,voli, ecc..... in alcuni casi sono quindi passibili di errori non ancora del tutto risolti.
Non fare affidamento sulle caratteristiche della carta avente una rappresentazione diversa nella realtà!
Ci si potrebbe perdere o finire in posti pericolosi e/0 non si può essere in grado di arrivare a destinazione.
Non vi è nessuna garanzia e nessuna richiesta di correttezza.

La mappa è anche una mappa specialistica perché è molto dettagliata e ha caratteristiche
che non importa a un uso più informale: per esempio, i contorni sono molto densi
a 10m di distanza. Il grande dettaglio è buono per gli escursionisti, che sono il pubblico principale per la mappa,
ma dovrebbe anche essere utile per i cartografi sul campo per rilevi e/o verifiche.


2. Installazione e utilizzo
---------------------------

La mappa è pensata per dispositivi mobili con sistema operativo Android e dispositivi Gps Garmin serie Gpsmap 64ST
(per il quale è stato sviluppato inizialmente). I test hanno dimostrato che verrà visualizzato anche su altri dispositivi.

La mappa in versione Garmin (il file gmapsupp.img) deve essere messo in una cartella denominata 'garmin'
sulla scheda micro SD e poi inserita nell'apposito slot all'interno del dispositivo. E' inoltre possibile caricare direttamente 
il file sulla scheda sd collegando il dispositivo al PC con l'apposito cavo in dotazione al dispositivo. Ovviamente la velocità di trasmissione sarà notevolmente più bassa.
Quando il dispositivo GPS viene acceso, viene visualizzata sullo schermo la schermata con le informazioni sulla licenza.
La mappa è abbastanza grande e ci vorrà un momento prima di essere caricata.
Un sacco di dettagli sono visibili solo ad un alto livello di zoom, quindi se mancano dettagli,
assicuratevi di avere uno zoom appropriato.

La mappa in versione PC è visualizzabile con il software Basecamp di Garmin sulle piattaforme Windows. Per poterla visualizzare
è necessario scompattarla (se scaricata da internet) e lanciare il batch install.bat per fare in modo che vengano scritte nel sistema le chiavi di registro e poi aprire il software Basecamp per poterla vedere.
Se invece è prodotta con questi script prelevare la cartella Basecamp dalla directory result per poi andarla ad installare come descritto prima.


3. Dettagli tecnici
-------------------


3.1 Prerequisiti
----------------

Per creare la mappa occorre che nel sistema (UBUNTU) siano presenti:

-- Python gdal

-- OpenJDK 7 oppure 8

-- 20 Gb di memoria liberi sul hard disk


3.2 Spazio occupato dai file
----------------------------

-- 7 Gb solo ed esclusivamente per i file componenti il BDTRE

-- 

3.3 ottenimento File del BDTRE
------------------------------

La Regione Piemonte mette a disposizione i dati del BDTRE (Base Dati Territoriale di Riferimento degli Enti)
per il riuso su base comunale, nominati secondo il proprio codice ISTAT, sia come WMS sia come dato cartografico.

I dati originali possono essere scaricati da questa pagina:

http:/www.geoportale2.piemonte.it/geocatalogorp/?sezione=catalogo    (cercare per "geotopografico" .....)


L'interfaccia non è molto adatto per l'acquisizione di tutti gli oltre 1200 comuni, ma avendo bisogno dei dati,
questa è la fonte ufficiale.
Per aiutare con il processo, una lista di tutti i comuni si trova all'interno della cartella "comuni".

Nella cartella "comuni" trovi un file pdf riepilogativo con tutti i comuni del Piemonte ed i relativi codici ISTAT. Per comodità i comuni
sono stati divisi in piccoli file per provincia. 
Per agevolare il dowload, sempre per provincia, sono stati creati dei file da dare in pasto a wget.
Per il download, occorre creare la directory (verificare il nome da dare alla cartell nel file di configurazione) e copiare i file di dowload nella cartella appena creata.
Da terminale, portarsi nella cartella e dare il comando wget -i nomeprovincia.txt e così via per tutte le province.
Wget ci metterà del tempo a scaricare tutti i comuni viste le dimensioni notevoli di alcune province, in totale ci vorranno circa 5/6 ore
ma molto dipende anche dalla reale velocità di download a disposizione.

Ad esempio, per scaricare i comuni della provincia di Asti, da terminale (nella directory di download) digitare wget -i Asti_D.txt ed inviare, wget andrà avanti fino a che non avrà provveduto a finire e per le altre provincie basta cambiare il nome della provincia.


3.4 Conversione dati da formato SHP a formato OSM
-------------------------------------------------

I dati sono raccolti, su base comunale, in svariati file in formato shapefile ESRI.
Lo shp è un formato di interscambio per geodati non proprietario e quindi fruibile da tutti.


Lavorare all'interno di questi limiti e di fornire gli stili appena scritti, il CTRN
dati potrebbero essere convertiti in una mappa GPS adatto per i dispositivi Garmin in due
passo processo. Il primo passo è stato quello di convertire i dati in OSM (OpenStreetMap)
formato. Questo formato è molto potente, e vi è uno strumento gratuito per convertire da
ESRI shapefile in formato OSM. Si chiama ogr2osm ed è disponibile in diversi
versioni, questo è quello utilizzato per questa mappa:

https://github.com/andrewguertin/ogr2osm/blob/master/ogr2osm.py

Funziona perché shapefile ESRI sono OGR-compatibili. I file risultanti in OSM
formato non sono decisamente file OSM "appropriati". OSM strutture formato di metadati per
le forme geometriche come tag: coppie di valori, mentre la comunità OSM forma un consenso
su quali tag vengono utilizzati e quali valori dovrebbero essere assegnati a loro. In
Al contrario, i file prodotti dai dati CTRN hanno selezionato solo ESRI
i nomi dei campi shapefile i tag ei ​​corrispondenti valori come valori. Dunque
questi dati non sono utilizzabili in un contesto OSM (come, per le importazioni).

Poiché l'obiettivo è quello di creare una mappa GPS, si scopre che questo non è un problema.
La seconda fase del processo, che crea i file in formato immagine garmin,
utilizza mkgmap, uno strumento OSM comune per creare mappe GPS per dispositivi Garmin. mkgmap è
file di stile nutriti, e in questi tag file di stile ei loro valori sono assegnati ai
codici per entità grafiche sulla mappa GPS. Questi tag ei ​​loro valori possono essere
scelti arbitrariamente, in modo che il 'strano' tag: coppie di valori dalla convertito CTRN
file possono essere utilizzati come qualsiasi altro tag: coppie di valori in formato OSM, e la
fatto che i file non sono 'adeguati' files OSM non importa.

Solo pochi tag vengono utilizzati dai dati originali, e solo una parte dei dati sono
usato. I dati CTRN sono solo un lato della mappa CTRN-OSM-GPS, l'altro lato è
un recente download 'corretto' i dati OSM. La mappa finale è una sintesi di entrambi i dati
imposta, e un tentativo è stato fatto per raccogliere le parti in modo che si completano a vicenda
altro. Il processo di selezione potrebbe essere descritto o meno così:

- Dove è necessaria la topografia di base, viene utilizzata la CTRN
- Modi e punti di interesse sono tratte principalmente da OSM

in alcune aree entrambi i set di dati forniscono dati. Ad esempio, OSM ha dati sui corpi di
acqua, ma i dati del CTRN sull'acqua sono molto più dettagliata. Così per l'acqua, la
Dati OSM non sono stati utilizzati a tutti e tutti i dati sono di acqua dal CTRN. Lo stesso
vale per gli edifici, anche se OSM sta diventando sempre più completo per
edifici. I dettagli specifici sono troppi per parlare; essi possono essere trovati
guardare i file di stile nella cartella stili. Pubblicazione del toolchain per
la creazione della mappa è anche un'offerta di modificare e adattare la mappa per personal
esigenze e il gusto; per alcuni usi il completo CTRN senza potenziamenti OSM
auspicabile, per altri dettagli più OSM.

Una delle principali aree di lavoro per la sintesi era tenere tutti gli stili
coerente e di fornire gli elementi grafici da utilizzare. I file di stile e di una
File TYP sono inclusi e può essere modificato in base alle esigenze; alcuni di questi sono originale
lavoro, e alcuni sono stati derivati ​​da modelli liberamente disponibili (vale a dire gli stili
in OSM-stile, che sono stati ottenuti dallo stile mkgmap di default).



























4. Costruzione della mappa, uso degli scripts
---------------------------------------------

Prima di iniziare a fare girare i vari script è bene sistemare i percorsi delle cartelle in cui si trovano i file scaricati ed i vari tool che concorrono al lavoro, le variabili vanno indicate nel file configurazione.
Tutte le variabili ed i percorsi sono tutte nel medesimo file, in modo che gli script vanno a richiamare le medesime senza doverle riscrivere o variare ogni volta che compaiono nei vari script.

Le variabili da settare sono le seguenti:

-- #sorgenti bdtre zippati = Cartella in cui sono presenti i file zippati inerenti i singoli comuni 

-- #sorgentibdtre non zippati = directory in cui verranno messi i file scompattati 

-- #shp usati = directory che conterrà i files shp utili alla creazione della mappa

-- #uscita osm = directory che conterrà i files osm

-- #uscita map = directory che conterrà i files map

-- #shp da usare: = specificare quali file shp (per ogni comune sono presenti piu file con diversi elementi territoriali differenti) si intende convertire, a seconda di quello che si vuole convertire o meno bisogna aggiungere o togliere file

-- # indirizzo per scaricare il file del piemonte = viene specificato l'indirizzo da cui scaricare i dati di openstreetmap che andranno ad integrarsi con i dati derivanti del BDTRE, in questo caso non bisogna modificare a meno che non cambi l'indirizzo

-- #file piemonte.osm = directorye nome del file del file scaricato da gfoss, che contiene i dati di osm da unire alla bdtre.
